<!DOCTYPE html>
<html lang="cn">

<head>
  <!-- ## for client-side less
  <link rel="stylesheet/less" type="text/css" href="https://pycntech.github.io/theme/css/style.less">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/less.js/1.7.3/less.min.js" type="text/javascript"></script>
  -->
  <link rel="stylesheet" type="text/css" href="https://pycntech.github.io/theme/css/style.css">
  <link rel="stylesheet" type="text/css" href="https://pycntech.github.io/theme/css/pygments.css">
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Sans|PT+Serif|PT+Mono">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="PyCN技术评论">
  <meta name="description" content="Posts and writings by PyCN技术评论">


<meta name="keywords" content="Python, OpenStack">

  <title>
    PyCN技术评论
&ndash; OpenStack源码分析之RabbitMQ（一）  </title>

</head>

<body>
  <aside>
    <div id="user_meta">
      <a href="https://pycntech.github.io">
        <img src="https://pycntech.github.io/theme/images/logo.png" alt="logo" height="200" width="200">
      </a>
      <h2><a href="https://pycntech.github.io">PyCN技术评论</a></h2>
      <p></p>
      <ul>
        <li><a href="https://github.com/PyCN/PTR" target="_blank">Py字幕组</a></li>
        <li><a href="https://github.com/PyCN" target="_blank">PyCN Github</a></li>
        <li><a href="https://python-chinese.github.io/" target="_blank">Python中文社区</a></li>
        <li><a href="https://github.com/pycntech/pycntech.github.io" target="_blank">关于本站</a></li>
      </ul>
    </div>
  </aside>

  <main>
    <header>
      <p>
      <a href="https://pycntech.github.io/index.html">首页</a> &brvbar; <a href="https://pycntech.github.io/archives.html">归档</a>
      </p>
    </header>

<article>
  <div class="article_title">
    <h1><a href="https://pycntech.github.io/OpenStack源码分析之RabbitMQ（一）-ZZR.html">OpenStack源码分析之RabbitMQ（一）</a></h1>
  </div>
  <div class="article_text">
    <h4>作者：ZZR</h4>
<p>ÔÚOpenstackÖÐ£¬¸÷¸ö×é¼þÄÚ²¿Ê¹ÓÃÏûÏ¢¶ÓÁÐ½øÐÐÍ¨ÐÅ£¬ÆäÖÐ£¬RabbitMQÊÇ³£ÓÃµÄÒ»ÖÖ¿ªÔ´ÏûÏ¢´úÀíÈí¼þ¡£ÕâÀï×÷Ò»¸ö¼òÒª½éÉÜ¡£</p>
<h2>RabbitMQ½éÉÜ</h2>
<p>RabbitMQÊµÏÖÁË¸ß¼¶ÏûÏ¢¶ÓÁÐÐ­Òé£¨AMQP£©¡£</p>
<h3>AMQP</h3>
<p>AMQPÊÇÒ»¸ö¶¨ÒåÁËÓ¦ÓÃÖ®¼äÏûÏ¢´«ËÍÐ­ÒéµÄ¿ª·Å±ê×¼. AMQPÖ¼ÔÚ½â¾öÔÚÁ½¸öÓ¦ÓÃÖ®¼ä´«ËÍÏûÏ¢´æÔÚµÄÒÔÏÂÎÊÌâ:</p>
<ul>
<li>ÍøÂçÊÇ²»¿É¿¿µÄ -&gt; ÏûÏ¢ÐèÒª±£´æºóÔÙ×ª·¢²¢ÓÐ³ö´í´¦Àí»úÖÆ</li>
<li>Óë±¾µØµ÷ÓÃÏà±È£¬ÍøÂçËÙ¶ÈÂý -&gt; µÃÖ§³ÖÒì²½µ÷ÓÃ</li>
<li>Ó¦ÓÃÖ®¼äÊÇ²»Í¬µÄ(±ÈÈçÊµÏÖÓïÑÔ²»Í¬, ²Ù×÷ÏµÍ³²»Í¬)£¬ÇÒÓ¦ÓÃ»á¾­³£±ä»¯ -&gt; µÃÓëÓ¦ÓÃÎÞ¹Ø</li>
</ul>
<p>AMQP Ê¹ÓÃÒì²½µÄ¡¢Ó¦ÓÃ¶ÔÓ¦ÓÃµÄ¡¢¶þ½øÖÆÊý¾ÝÍ¨ÐÅÀ´½â¾öÕâÐ©ÎÊÌâ¡£</p>
<h3>»ù±¾×é¼þ</h3>
<p>RabbitMQ ÊÇ AMQP µÄÒ»ÖÖÊµÏÖ, Æä»ù±¾×é¼þ°üÀ¨£º
- Producer£ºMessageµÄÉú²úÕß, ¸ºÔð²úÉúÏûÏ¢²¢°ÑÏûÏ¢·¢µ½Exchange¡£
- Message£ºRabbitMQ ×ª·¢µÄ¶þ½øÖÆ¶ÔÏó£¬°üÀ¨Headers¡¢PropertiesºÍ Data¡£ÆäÖÐData²»ÊÇ±ØÒªµÄ¡£
- Exchange£º¸ºÔð½ÓÊÕProducerµÄMessage, ²¢°ÑËü×ª·¢µ½ºÏÊÊµÄQueue.
- Binding£º±êÊ¶QueueºÍExchangeÖ®¼äµÄ¹ØÏµ¡£Exchange¸ù¾ÝMessageµÄPropertiesºÍBindingµÄPropertiesÀ´È·¶¨½«ÏûÏ¢×ª·¢µ½ÄÄÐ©Queue¡£Ò»¸öÖØÒªµÄPropertiesÊÇbinding_key¡£
- Queue£º»º´æExchange·¢À´µÄÏûÏ¢£¬²¢½«ÏûÏ¢Ö÷¶¯·¢¸øConsumer»òÕßÓÉConsumerÖ÷¶¯À´»ñÈ¡ÏûÏ¢¡£
- Consumer£ºÊ¹ÓÃQueue´ÓExchangeÖÐ»ñÈ¡Message¡£</p>
<p><img alt="rabbitmq-basic-structure" src="index_files/rabbitmq-basic-structure.jpg" title="rabbitmq-basic-structure" /></p>
<h3>MessageºÍExchange</h3>
<h4>Message</h4>
<p>ÏûÏ¢½á¹¹°üÀ¨£ºHeaders¡¢PropertiesºÍdata¡£</p>
<p>ÆäÖÐ£¬Properties°üÀ¨¼¸¸öÖØÒªµÄÊôÐÔ£º</p>
<ul>
<li>routing_key£ºDirectºÍTopicÀàÐÍµÄexchange»á¸ù¾Ý±¾ÊôÐÔÀ´×ª·¢ÏûÏ¢¡£</li>
<li>delivery_mode£º½«ÆäÖµÉèÖÃÎª2½«Ê¹ÓÃÏûÏ¢³Ö¾Ã»¯¡£³Ö¾Ã»¯µÄÏûÏ¢»á±»±£´æµ½´ÅÅÌ¡£</li>
<li>reply_to£º¿Í»§¶Ë»Øµ÷¶ÓÁÐµÄÃû×Ö¡£</li>
<li>correlation_id</li>
<li>content_type</li>
</ul>
<h4>Exchange</h4>
<p>ExchangeÓÐ¼¸¸öÖØÒªµÄÊôÐÔ£º</p>
<ul>
<li>name£ºexchangeÃû×Ö¡£¿Õ×Ö·û´®Ãû×ÖµÄexchangeÎªÄ¬ÈÏµÄexchange¡£</li>
<li>type£º¾ö¶¨ÁËexchangeµÄÏûÏ¢×ª·¢·½Ê½, °üÀ¨direct¡¢fanout¡¢topicºÍheaders¡£</li>
<li>durable£ºÖµÎªTrueµÄexchange»áÔÚrabbitmqÖØÆô»á×Ô¶¯´´½¨¡£OpenstackÊ¹ÓÃµÄexchange¸ÃÖµ¶¼ÎªFalse¡£</li>
<li>auto_delete£ºÖµÎªTrueµÄexchangeµ±Ïû·ÑÕßµÄÁ¬½Ó¶¼¹Ø±Õºó»á±»×Ô¶¯É¾³ý¡£ OpenstackÊ¹ÓÃµÄexchange¸ÃÖµ¶¼ÎªFalse¡£</li>
<li>exclusive£ºÉèÖÃÎªTrueµÄ»°£¬¸ÃexchangeÖ»ÔÊÐí±»´´½¨µÄconnectionÊ¹ÓÃ£¬ÇÒÔÚ¸Ãconnection¹Ø±ÕºóËü»á×Ô¶¯É¾³ý¡£</li>
</ul>
<h3>RabbitMQÏûÏ¢Â·ÓÉ»úÖÆ</h3>
<p>¾ö¶¨ExchangeÏûÏ¢Â·ÓÉµÄÊôÐÔÓÐ:</p>
<ul>
<li>ExchangeµÄtype</li>
<li>MessageµÄrouting_key</li>
<li>BindingµÄbinding_key</li>
</ul>
<p>¾ßÌå¹æÔòÈçÏÂ:</p>
<table>
<thead>
<tr>
<th>Exchange:type</th>
<th>Message:routing_key</th>
<th>Binding:bingding_key</th>
<th>Â·ÓÉ¹æÔò</th>
</tr>
</thead>
<tbody>
<tr>
<td>Fanout</td>
<td>ºöÂÔ</td>
<td>ºöÂÔ</td>
<td>Exchange ½«ÏûÏ¢×ª·¢µ½ËùÓÐÓëËüÓÐ binding ¹ØÏµµÄ¶ÓÁÐÖÐ. ÕâÖÖ·½·¨×ª·¢Ð§ÂÊ½Ï¸ß. OpenStack ´óÁ¿Ê¹ÓÃÕâÖÖÀàÐÍµÄexchange.</td>
</tr>
<tr>
<td>Direct</td>
<td>routing_key £¨ÈÎÒâµÄ×Ö·û´®, ±ÈÈç "abc"£©</td>
<td>binding_key £¨ÈÎÒâµÄ×Ö·û´®£¬±ÈÈç "abc"£©</td>
<td>Exchange Ö»½«ÏûÏ¢×ªµ½ binding µÄ binding_key µÈÓÚÏûÏ¢µÄ routing_key µÄ¶ÓÁÐÖÐ¡£</td>
</tr>
<tr>
<td>Topic</td>
<td>routing_key £¨ÒÔ "." ·Ö¸îµÄ¶àµ¥´Ê×Ö·û´®£¬±ÈÈç abc.efg.hij£©</td>
<td>binding_key £¨°üº¬ "#" ºÍ "*" µÄÒÔ ¡°.¡± ·Ö¸îµÄ¶àµ¥´Ê×Ö·û´®£¬±ÈÈç *.efg.*£©</td>
<td>Exchange Ö»½«ÏûÏ¢×ªµ½ÏûÏ¢µÄ routing_key ºÍ binding µÄ binding_key Æ¥ÅäµÄ¶ÓÁÐÖÐ¡£</td>
</tr>
<tr>
<td></td>
<td>headers</td>
<td>binding_key</td>
<td>Exchange Ö»½«ÏûÏ¢×ªµ½ÏûÏ¢µÄ headers ºÍ binding µÄ binding_key Æ¥ÅäµÄ¶ÓÁÐÖÐ¡£Æ¥Åä¹æÔò´ýÑÐ¾¿¡£OpenStack²»Ê¹ÓÃ¸ÃÀàÐÍµÄexchange¡£</td>
</tr>
</tbody>
</table>
<p>RabbitMQÓÐ¶àÖÖ°æ±¾µÄ¿Í»§¶Ë£¬±¾ÎÄÊ¹ÓÃPika£¬°²×°ÈçÏÂ¡£</p>
<div class="highlight"><pre><span></span>$ pip install pika
</pre></div>


<h2>RabbitMQÀ©Õ¹²å¼þ</h2>
<h3>Management Plugin</h3>
<p>Ìá¹©GUIÀ´¹ÜÀíRabbitMQ¡£¹Ù·½µØÖ·£º<a href="https://www.rabbitmq.com/management.html">https://www.rabbitmq.com/management.html</a></p>
<p>RabbitMQÓÃ»§ÃÜÂë¿ÉÒÔÔÚ<code>/etc/rabbitmq/abbitmq.config</code>²é¿´£º</p>
<p><img alt="rabbitmq-user-passwd" src="index_files/rabbitmq-user-passwd.png" /></p>
<p>´ò¿ªÍ¼ÐÎ½çÃæ£º</p>
<div class="highlight"><pre><span></span><span class="c1"># rabbitmq-plugins enable rabbitmq_management</span>
</pre></div>


<p>È»ºóÍ¨¹ý¶Ë¿Ú15672¾Í¿ÉÒÔ·ÃÎÊweb¹ÜÀí½çÃæ¡£</p>
<p><img alt="rabbitmq_management_ui" src="index_files/rabbitmq_management_ui.png" /></p>
<h2>Hello World!</h2>
<p>Ê×ÏÈ£¬ÎÒÃÇ³¢ÊÔ´ÓPublisher·¢ËÍÒ»ÌõÏûÏ¢¡°Hello World¡±µ½Consumer¡£</p>
<p><img alt="hello-world-example-routing" src="index_files/hello-world-example-routing.png" /></p>
<h3>Publisher</h3>
<p><strong>·¢ËÍÏûÏ¢</strong>Ö÷Òª°üÀ¨ÒÔÏÂ¼¸¸ö²Ù×÷£º
1. ÓëRabbitMQ½¨Á¢Á¬½Ó¡£
2. ÉùÃ÷ÒªÊ¹ÓÃµÄqueue¡£
3. RabbitMQÖÐ£¬ÏûÏ¢²»»áÖ±½Ó·¢µ½queue£¬¶øÊÇ·¢µ½exchange£¬ÓÉexchange×ª·¢µ½ÏàÓ¦µÄqueue¡£ÏÂÃæµÄÀý×ÓÖÐÊ¹ÓÃÁËÄ¬ÈÏµÄexchange£¬Ëü»á½øÐÐ¶¨Ïò×ª·¢£¬Ò²¾ÍÊÇ½«message·¢µ½routing_keyËùÖ¸¶¨µÄqueueÖÐ¡£
4. ×îºó£¬ÎªÁË±£Ö¤ÍøÂç»º´æflushed£¨Ò²¾ÍÊÇÏûÏ¢±»·¢³öÈ¥ÁË£©£¬ÊÖ¶¯¹Ø±ÕÁ¬½Ó¡£</p>
<div class="highlight"><pre><span></span><span class="c1"># filename: send.py</span>
<span class="c1">#!/usr/bin/env python</span>
<span class="kn">import</span> <span class="nn">pika</span>


<span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">BlockingConnection</span><span class="p">(</span><span class="n">pika</span><span class="o">.</span><span class="n">ConnectionParameters</span><span class="p">(</span>
    <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">))</span>
<span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">channel</span><span class="p">()</span>
<span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">queue</span><span class="o">=</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
<span class="n">channel</span><span class="o">.</span><span class="n">basic_publish</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                      <span class="n">routing_key</span><span class="o">=</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span>
                      <span class="n">body</span><span class="o">=</span><span class="s1">&#39;Hello World!&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot; [x] Sent &#39;Hello World!&#39;&quot;</span><span class="p">)</span>
<span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>


<p>Ö´ÐÐÍêÒÔÉÏÖ¸Áî£¬Í¨¹ýÃüÁîÐÐÄã¿ÉÒÔ¿´µ½queueÒÑ¾­±»½¨Á¢ÇÒ°üº¬ÁËÎÒÃÇ·¢³öµÄÐÅÏ¢£º</p>
<p><img alt="list_queue_hello" src="index_files/list_queue_hello.png" /></p>
<h3>Consumer</h3>
<p><strong>½ÓÊÕÏûÏ¢</strong>Ö÷Òª°üÀ¨ÒÔÏÂ¼¸¸ö²Ù×÷£º
1. ÓëRabbitMQ½¨Á¢Á¬½Ó¡£
2. ÉùÃ÷¼àÌýµÄqueue¡£
3. ½¨Á¢consumer¡£comsumerÐèÒªÒ»¸ö»Øµ÷º¯ÊýÀ´¸ºÔð´¦Àí½ÓÊÕµ½µÄÏûÏ¢¡£
4. start_consuming()£¬Æä±¾ÖÊÊÇÒ»¸öwhileÑ­»·£¬²»¶ÏÈ¡³ö¶ÓÁÐÖÐµÄÏûÏ¢¡£</p>
<div class="highlight"><pre><span></span><span class="c1"># filename: receive.py</span>
<span class="c1">#!/usr/bin/env python</span>
<span class="kn">import</span> <span class="nn">pika</span>


<span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">BlockingConnection</span><span class="p">(</span><span class="n">pika</span><span class="o">.</span><span class="n">ConnectionParameters</span><span class="p">(</span>
    <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">))</span>
<span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">channel</span><span class="p">()</span>
<span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">queue</span><span class="o">=</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot; [x] Received </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">body</span><span class="p">)</span>
<span class="n">channel</span><span class="o">.</span><span class="n">basic_consume</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span>
                      <span class="n">queue</span><span class="o">=</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span>
                      <span class="n">no_ack</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39; [*] Waiting for messages. To exit press CTRL+C&#39;</span><span class="p">)</span>
<span class="n">channel</span><span class="o">.</span><span class="n">start_consuming</span><span class="p">()</span>
</pre></div>


<p><img alt="receive_hello_world" src="index_files/receive_hello_world.png" /></p>
<h2>Work Queues</h2>
<p>ÔÚÉÏÒ»¸öÀý×ÓÖÐ£¬consumerÖ»ÊÇ¼òµ¥µØ´òÓ¡ÐÅÏ¢£¬ÔÚÕâ¸öÀý×ÓÖÐ£¬ÎÒÃÇ½«consumer¸ÄÎªÒ»¸öworker£¬Ëü½«¸ù¾ÝÏûÏ¢Íê³ÉÒ»Ð©ÈÎÎñ¡£Æä±¾ÖÊºÍprint("hello world")²¢Ã»ÓÐÊ²Ã´Çø±ð£¬µ«ÊÇÎªÁË±£Ö¤ÈÎÎñÄÜÕýÈ·Íê³É£¬ÐèÒªÒ»Ð©¶îÍâµÄ²Ù×÷£¬Ê¹workder¸ü½¡×³¡£</p>
<h3>consumer¹ÒÁËÔõÃ´°ì</h3>
<p>¸ÄÐ´ÒÔÉÏ´úÂë¡£</p>
<p>publisher·¢ËÍµÄÏûÏ¢¿ÉÒÔ´ÓÃüÁî²ÎÊýÖÐ¶ÁÈ¡¡£²ÎÊý°üÀ¨Èô¸É¸öµã£¬µãµÄÊýÁ¿¾ö¶¨ÁËconsumerÐèÒª»¨¶àÉÙÃëÀ´Íê³ÉÈÎÎñ£º</p>
<div class="highlight"><pre><span></span><span class="c1"># send.py</span>
<span class="n">message</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="ow">or</span> <span class="s2">&quot;Hello World!&quot;</span>
<span class="n">channel</span><span class="o">.</span><span class="n">basic_publish</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                      <span class="n">routing_key</span><span class="o">=</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span>
                      <span class="n">body</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot; [x] Sent </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
</pre></div>


<p>consumer´¦ÀíÏûÏ¢µÄ»Øµ÷º¯Êý£¬½«¸ù¾Ýmessage½øÐÐsleep()£º</p>
<div class="highlight"><pre><span></span><span class="c1"># receive.py</span>
<span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot; [x] Received </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">body</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">body</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">b</span><span class="s1">&#39;.&#39;</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot; [x] Done&quot;</span><span class="p">)</span>
    <span class="n">ch</span><span class="o">.</span><span class="n">basic_ack</span><span class="p">(</span><span class="n">delivery_tag</span><span class="o">=</span><span class="n">method</span><span class="o">.</span><span class="n">delivery_tag</span><span class="p">)</span>
<span class="n">channel</span><span class="o">.</span><span class="n">basic_consume</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span>
                      <span class="n">queue</span><span class="o">=</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
</pre></div>


<p>µ±consumer´¦ÀíÍêÈÎÎñ£¬»á»Ø¸´ack¡£Èç¹ûÃ»ÓÐack£¬Õâ¸öÏûÏ¢½«ÔÚqueueÖÐ´¦ÓÚunacknowledged×´Ì¬¡£Èç¹ûÕâ¸öconsumer´¦Àí¹ý³ÌÖÐ¹ÒÁË£¬Õâ¸ömessage½«±»·Ö·¢¸øÆäËüconsumer¡£Õâ¸ö»úÖÆ<strong>±£Ö¤ÁËËùÓÐµÄÏûÏ¢¶¼¿ÉÒÔ±»´¦Àí</strong>¡££¨Ò»ÖÖºÜ»µµÄÇé¿öÊÇ£¬consumer´¦ÀíÁËmessageµ«Ã»ÓÐ·µ»Øack£¬µ«Õâ¸öconsumerÓÖÒ»Ö±²»¹Ò£¬ÄÇÃ´ÕâÐ©±»Ëü´¦ÀíµÄmessage¾Í»áÒ»Ö±ÒÔunackµÄ×´Ì¬±£´æÔÚqueueÖÐ¡££©</p>
<p><img alt="list_queue_unack" src="index_files/list_queue_unack.png" /></p>
<h3>rabbitmq¹ÒÁËÔõÃ´°ì</h3>
<p>ÎªÁË±£Ö¤rabbitmq¹ÒÁË¶¼²»»áÊ¹messageÏûÊ§£¬ÎÒÃÇ±ØÐë±£Ö¤£º
- queue³Ö¾Ã»¯
- message³Ö¾Ã»¯</p>
<p>ÓÉÓÚrabbitmq²»ÔÊÐíÁ½¸ö¶ÓÁÐÖØÃû£¬ÏÂÃæµÄ´úÂë¸ÄÓÃtask_queue×÷Îª¶ÓÁÐÃû¡£ÐÞ¸Ä´úÂëÈçÏÂ£º</p>
<div class="highlight"><pre><span></span><span class="c1"># filename: send.py</span>
<span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">queue</span><span class="o">=</span><span class="s1">&#39;task_queue&#39;</span><span class="p">,</span> <span class="n">durable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">channel</span><span class="o">.</span><span class="n">basic_publish</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                      <span class="n">routing_key</span><span class="o">=</span><span class="s2">&quot;task_queue&quot;</span><span class="p">,</span>
                      <span class="n">body</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
                      <span class="n">properties</span><span class="o">=</span><span class="n">pika</span><span class="o">.</span><span class="n">BasicProperties</span><span class="p">(</span>
                          <span class="n">delivery_mode</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="p">)</span>
                      <span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># filename: receive.py</span>
<span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">queue</span><span class="o">=</span><span class="s1">&#39;task_queue&#39;</span><span class="p">,</span> <span class="n">durable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>


<h3>ÈÎÎñÆ½¾ù·ÖÅä</h3>
<p>Ä¿Ç°µÄÇé¿öÊÇ£¬ÈÎÎñ½«±»Æ½¾ù·ÖÅä¸øÃ¿Ò»¸öconsumer¡£±ÈÈç£¬Èç¹ûÓÐÁ½¸öconsumer£¬ÄÇÃ´ÈÎÎñ½«ÄãÒ»¸öÎÒÒ»¸öÀ´·ÖÅä£¬¶ø²»»á¸ù¾ÝÈÎÎñµÄ¸´ÔÓ¶ÈÀ´·ÖÅä¡£Ò»ÖÖ¼«¶ËÇé¿öÊÇ£¬ÆæÊýÈÎÎñ¸´ÔÓ¶ÈºÜ¸ß£¬Å¼ÊýÈÎÎñ¸´ÔÓ¶ÈºÜµÍ£¬ÄÇÃ´¾Í»áµ¼ÖÂÒ»¸öconsumerÒ»Ö±ºÜÃ¦£¬¶øÁíÒ»¸öÒ»Ö±ºÜÏÐ¡£Îª´Ë£¬½øÒ»²½ÐÞ¸Ä´úÂë£º</p>
<div class="highlight"><pre><span></span><span class="c1"># filename: receive.py</span>
<span class="n">channel</span><span class="o">.</span><span class="n">basic_qos</span><span class="p">(</span><span class="n">prefetch_count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>


<p>Õâ¸ö²ÎÊýÏÞÖÆÁËconsumerÊÖÉÏµÄmessageÊýÁ¿¡£Èç¹ûconsumerÊÖÉÏÒÑ¾­ÓÐÒ»¸öunackµÄmessage£¬ÄÇÃ´ºóÐøµÄmessage¾Í²»»á·¢¸øËüÁË¡£</p>
<p><img alt="prefetch-count" src="index_files/prefetch-count.png" /></p>
<h3>ÍêÕû´úÂë</h3>
<div class="highlight"><pre><span></span><span class="c1"># filename: send.py</span>
<span class="c1"># !/usr/bin/env python</span>
<span class="kn">import</span> <span class="nn">pika</span>
<span class="kn">import</span> <span class="nn">sys</span>


<span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">BlockingConnection</span><span class="p">(</span><span class="n">pika</span><span class="o">.</span><span class="n">ConnectionParameters</span><span class="p">(</span>
    <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">))</span>
<span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">channel</span><span class="p">()</span>
<span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">queue</span><span class="o">=</span><span class="s1">&#39;task_queue&#39;</span><span class="p">,</span> <span class="n">durable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">message</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="ow">or</span> <span class="s2">&quot;Hello World!&quot;</span>
<span class="n">channel</span><span class="o">.</span><span class="n">basic_publish</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                      <span class="n">routing_key</span><span class="o">=</span><span class="s2">&quot;task_queue&quot;</span><span class="p">,</span>
                      <span class="n">body</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
                      <span class="n">properties</span><span class="o">=</span><span class="n">pika</span><span class="o">.</span><span class="n">BasicProperties</span><span class="p">(</span>
                          <span class="n">delivery_mode</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="p">)</span>
                      <span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot; [x] Sent </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
<span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># filename: receive.py</span>
<span class="c1">#!/usr/bin/env python</span>
<span class="kn">import</span> <span class="nn">pika</span>
<span class="kn">import</span> <span class="nn">time</span>


<span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">BlockingConnection</span><span class="p">(</span><span class="n">pika</span><span class="o">.</span><span class="n">ConnectionParameters</span><span class="p">(</span>
    <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">))</span>
<span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">channel</span><span class="p">()</span>
<span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">queue</span><span class="o">=</span><span class="s1">&#39;task_queue&#39;</span><span class="p">,</span> <span class="n">durable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">channel</span><span class="o">.</span><span class="n">basic_qos</span><span class="p">(</span><span class="n">prefetch_count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot; [x] Received </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">body</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">body</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">b</span><span class="s1">&#39;.&#39;</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot; [x] Done&quot;</span><span class="p">)</span>
    <span class="n">ch</span><span class="o">.</span><span class="n">basic_ack</span><span class="p">(</span><span class="n">delivery_tag</span><span class="o">=</span><span class="n">method</span><span class="o">.</span><span class="n">delivery_tag</span><span class="p">)</span>
<span class="n">channel</span><span class="o">.</span><span class="n">basic_consume</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span>
                      <span class="n">queue</span><span class="o">=</span><span class="s1">&#39;task_queue&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39; [*] Waiting for messages. To exit press CTRL+C&#39;</span><span class="p">)</span>
<span class="n">channel</span><span class="o">.</span><span class="n">start_consuming</span><span class="p">()</span>
</pre></div>


<p>ÔÙ»Ø¹ËÒ»ÏÂÉÏÃæµÄ´úÂë¡£Ê×ÏÈÃ÷È·£¬ÕâÖÖÇé¿öÊ¹ÓÃµÄÊÇÄ¬ÈÏexchange¡£¶ÔÓÚproducer£¬Ëü½«ÏûÏ¢½»¸øexchange£¬È»ºóexchangeÍ¨¹ýrouting keyÀ´ÅÐ¶ÏÒª½«ÏûÏ¢½»µ½ÄÄ¸öqueue¡£Êµ¼ÊÉÏÏàµ±ÓÚ½«ÏûÏ¢Ö±½Ó·¢ËÍµ½queueÖÐ¡£¶øconsumerÖ±½ÓÖ¸¶¨queueµÄÃû×Ö£¬Ò²¾ÍÊÇËüÖ±½Ó°ó¶¨µ½Õâ¸öqueue¡£Õâ¸ö¹ý³ÌÖÐexchangeÆäÊµÃ»Ê²Ã´´æÔÚ¸Ð¡£</p>
  </div>
  <div class="article_meta">
    <p>发布于: 六 24 十二月 2016</p>
    <p>分类: <a href="https://pycntech.github.io/category/python-yun-ji-suan.html">Python 云计算</a>
 &ndash; 标签:
      <a href="https://pycntech.github.io/tag/python.html">Python</a>,      <a href="https://pycntech.github.io/tag/openstack.html">OpenStack</a>    </p>
  </div>


</article>


    <div id="ending_message">
      <p>&copy; PyCN技术评论. Built using <a href="http://getpelican.com" target="_blank">Pelican</a>. Theme by Giulio Fidente on <a href="https://github.com/gfidente/pelican-svbhack" target="_blank">github</a>. </p>
    </div>
  </main>
</body>
</html>